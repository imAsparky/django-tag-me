[tox]
# Usage: TOX_SKIPSDIST=false TOX_ISOLATED_BUILD=true tox
# Or add them to your environment, .env etc and just run tox.
# - Override for faster dev testing:
#   TOX_SKIPSDIST=true TOX_ISOLATED_BUILD=false tox
# Comprehensive testing with x-dist:
# - Isolated builds for worker consistency.
# - Full package builds for accurate testing.
skipsdist = {env:TOX_SKIPSDIST:false}
isolated_build = {env:TOX_ISOLATED_BUILD:true}
workdir = ../.tox
skip_missing_interpreters = true
env_list =
    py{310}-dj{40}
    py{310,311}-dj{41}
    py{310,311,312}-dj{42}
    py{310,311,312,313}-dj{50,51,52}
    py{313,314}-dj{60}
    py{313,314}-dj{main}
minversion = 4.23.0

# This section controls which environments run in GitHub Actions
[gh-actions]
python =
    3.11: py311-dj42
    3.13: py313-dj52
    3.14: py314-dj60

[testenv]
allowlist_externals =
    find
    rm
    mkdir
description = run the tests with pytest
passenv =
    TESTING_*
setenv =
    PYTHONPATH = {toxinidir}
    PYTHONWARNINGS = once::DeprecationWarning
    PIP_DISABLE_PIP_VERSION_CHECK = 1
deps =
    dj40: Django>=4.0,<4.1
    dj41: Django>=4.1,<4.2
    dj42: Django>=4.2,<5.0
    dj50: Django>=5.0,<5.1
    dj51: Django>=5.1,<5.2
    dj52: Django>=5.2,<6.0
    dj60: Django>=6.0,<6.1
    djmain: https://github.com/django/django/archive/main.tar.gz
    -r{toxinidir}/requirements.txt
commands =
    {[preclean]commands}
    {[cov_clean]commands}
    {[pipupgrade]commands}
    pytest {tty:--color=yes} {posargs:tests} -v
    {[cleanup]commands}

[preclean]
commands =
    rm -rf .pytest_cache
    rm -rf coverage.xml
    rm -rf htmlcov

[cov_clean]
deps = coverage
commands = coverage erase

[cleanup]
commands =
    find {toxinidir} -type f -name "*.pyc" -delete
    find {toxinidir} -type f -path "*.egg-info*" -delete
    find {toxinidir} -type d -name "__pycache__" -exec rm -rf {} +
    find {toxinidir} -type d -path "*.egg-info" -exec rm -rf {} +
    find {toxinidir} -type d -name ".pytest_cache" -exec rm -rf {} +

[pipupgrade]
commands =
    {envpython} -m pip install --upgrade pip

[pytest]
addopts =
    --cov-config=.coveragerc
    --cov=.
    --cov-fail-under=50
    --cov-report term-missing:skip-covered
    --cov-report=xml
    --cov-report=html
    --cov-branch
    --dist loadscope
    --maxfail=6
    --failed-first
    --durations 10
    --numprocesses auto
    ; ── Uncomment to isolate by group ──
    ; --ignore=tests/unit/
    ; --ignore=tests/db/
    ; --ignore=tests/forms/
    ; --ignore=tests/views/
    ; --ignore=tests/system/
    ; --ignore=tests/templatetags/
    ; ── Uncomment to isolate individual files ──
    ; --ignore=tests/unit/test_assets.py
    ; --ignore=tests/unit/test_collections.py
    ; --ignore=tests/unit/test_form_field.py
    ; --ignore=tests/unit/test_parser.py
    ; --ignore=tests/db/test_fk_migration.py
    ; --ignore=tests/db/test_model_field.py
    ; --ignore=tests/db/test_models.py
    ; --ignore=tests/forms/test_form_mixins.py
    ; --ignore=tests/forms/test_widget.py
    ; --ignore=tests/views/test_views.py
    ; --ignore=tests/views/test_view_mixins.py
    ; --ignore=tests/system/test_orphan_merger.py
    ; --ignore=tests/system/test_registry.py
    ; --ignore=tests/system/test_tag_mgmt_system.py
    ; --ignore=tests/templatetags/test_templatetags.py
filterwarnings =
    ignore::DeprecationWarning
DJANGO_SETTINGS_MODULE = tests.settings
testpaths = tests
python_files = test_*.py
norecursedirs =
    *.egg
    .*
    _darcs
    build
    CVS
    dist
    node_modules
    venv
    {arch}
    _build
    templates
    tmp*
markers =
    slow: slow running test
